// utils.c
#include <stdint.h>
#include <string.h>
#include <stdbool.h>
#include "common.h"
#include "utils.h"

//============================================================================
//=======================[ Util_setbit ]======================================
//============================================================================

static uint8_t _bits[FLAGS_COUNT];

void Util_setbit( uint16_t flag, uint8_t bit )
{
  _bits[flag]=_bits[flag] | bit;
}

//============================================================================
//=======================[ Util_clrbit ]======================================
//============================================================================

void Util_clrbit( uint16_t flag, uint8_t bit )
{
  _bits[flag]=_bits[flag] &(~bit);
}

//============================================================================
//=======================[ Util_istrue ]======================================
//============================================================================

uint8_t Util_istrue( uint16_t flag, uint8_t bit )
{
  return _bits[flag] & bit;
}

//============================================================================
//=======================[ Util_isfalse ]=====================================
//============================================================================

uint8_t Util_isfalse( uint16_t flag, uint8_t bit )
{
  return (_bits[flag] & bit) ^ bit ;
}

//============================================================================
//=======================[ Util_bin2hex ]=====================================
//============================================================================

void Util_bin2hex( uint8_t * pbuf, uint8_t data )
{
  uint8_t hex;
  hex=data>>4;
  if( hex < 10 ) hex=hex+'0';
  else hex=(hex-10)+'A';
  *pbuf++=hex;
  hex=data&0x0F;
  if( hex < 10 ) hex=hex+'0';
  else hex=(hex-10)+'A';
  *pbuf++=hex;
}

//============================================================================
//=======================[ Util_bin2hex16 ]===================================
//============================================================================

void Util_bin2hex16( uint8_t * pbuf, uint32_t data )
{
  Util_bin2hex( pbuf+0, data>>8 ); 
  Util_bin2hex( pbuf+2, data);
}


//============================================================================
//=======================[ Util_bin2hex32 ]===================================
//============================================================================

void Util_bin2hex32( uint8_t * pbuf, uint32_t data )
{
  Util_bin2hex( pbuf+0, data >>24);
  Util_bin2hex( pbuf+2, data>>16 );
  Util_bin2hex( pbuf+4, data>>8 ); 
  Util_bin2hex( pbuf+6, data);
}

//============================================================================
//=======================[ Util_ascii2bin ]===================================
//============================================================================

uint16_t Util_ascii2bin( uint8_t a )
{
  uint16_t d;
  d=a-'0';
  if( d>9 ) d=0;
  return d;
}

//============================================================================
//=======================[ Util_ascii2bin_p3 ]================================
//============================================================================

uint16_t Util_ascii2bin_p3( uint8_t * p )
{
  uint16_t d;
  d=Util_ascii2bin( p[0] );
  d=d*10+Util_ascii2bin( p[1] );
  d=d*10+Util_ascii2bin( p[2] );
  return d;
}

//============================================================================
//=======================[ Util_16bin2dec ]===================================
//============================================================================

// convert unsigned int to ascii decimal 5 places, left justified

// we need to move this and other stuff to a utils.c
uint16_t Util_16bin2dec( uint8_t * pbuf, uint16_t data )
{
  uint8_t i;
  uint8_t cp=0;
  uint16_t w;
  uint16_t width;
  memset( pbuf, ' ', 5 ); // blank the field, we will left justify
  if( data>9999 )     i=0;
  else if( data>999 ) i=1;
  else if( data>99  ) i=2;
  else if( data>9   ) i=3;
  else                i=4;

  width=5-i;
    
  // should put in loop
    
  if( i==0 )
  {
    w=data/10000;
    pbuf[cp++]='0'+w;
    data=data-w*10000;
    i++;
  }
  if( i==1 )
  {
    w=data/1000;
    pbuf[cp++]='0'+w;
    data=data-w*1000;
    i++;
  }
  if( i==2 )
  {
    w=data/100;
    pbuf[cp++]='0'+w;
    data=data-w*100;
    i++;
  }
  if( i==3 )
  {
    w=data/10;
    pbuf[cp++]='0'+w;
    data=data-w*10;
  }
  pbuf[cp]='0'+data;
  return width;
}

//============================================================================
//=======================[ Util_99bin2dec ]===================================
//============================================================================

// convert unsigned int to ascii decimal 2, do not zero blank

void Util_99bin2dec( uint8_t * pbuf, uint8_t data )
{
  uint16_t w;
  pbuf[0]='?';
  pbuf[1]='?';
  if( data>99 ) return;
  w=data/10;
  pbuf[0]='0'+w;
  w=w*10;
  data=data-w;
  pbuf[1]='0'+data;
}
















//============================================================================
//=======================[ delay_ms ]=========================================
//============================================================================
// temp

volatile uint32_t xd;

void delay_ms( uint16_t d )
{
  while(d--)
  {
    xd=10000;
    while(xd--)
    {
    }
  }
}

